# Makefile para API en Rails con Docker

# ------------------------------------------------------------------------------
# CONFIGURACIÃ“N
# Personaliza estas variables segÃºn tu proyecto.
# ------------------------------------------------------------------------------

# Nombre de la aplicaciÃ³n/servicio web en tu docker-compose.yml
APP_NAME := web

# Comandos base de Docker Compose. El --rm elimina el contenedor despuÃ©s de cada ejecuciÃ³n.
COMPOSE_RUN  := docker-compose run --rm $(APP_NAME)
COMPOSE_EXEC := docker-compose exec $(APP_NAME)
COMPOSE_LOGS := docker-compose logs -f

# ------------------------------------------------------------------------------
# COMANDOS
# El objetivo por defecto es 'help', asÃ­ que `make` mostrarÃ¡ la ayuda.
# ------------------------------------------------------------------------------
.DEFAULT_GOAL := help

.PHONY: help build up start down stop destroy logs ps shell console c test test-file db-setup db-create db-migrate db-seed db-reset routes

# Comandos de Ayuda
help: ## ğŸ“– Muestra esta lista de ayuda con todos los comandos disponibles.
	@echo "ğŸš— Sistema Lubricentro - Comandos Disponibles"
	@echo "=============================================="
	@echo ""
	@echo "ğŸ³ GESTIÃ“N DE DOCKER:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / && $$2 ~ /ğŸ³|ğŸš€|ğŸ›‘|ğŸ’£|ğŸ“œ|ğŸ“Š/ {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "ğŸš CONSOLAS Y SHELL:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / && $$2 ~ /ğŸš|ğŸ’/ {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "ğŸ› ï¸  BASE DE DATOS Y RAILS:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / && $$2 ~ /ğŸ› ï¸|ğŸŒ±|ğŸƒ|ğŸŒ°|â™»ï¸|ğŸ—ºï¸/ {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "ğŸ§ª TESTING:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / && $$2 ~ /ğŸ§ª|ğŸ”¬/ {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)
	@echo ""
	@echo "ğŸ“– AYUDA:"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / && $$2 ~ /ğŸ“–/ {printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# ------------------------------------------------------------------------------
# GESTIÃ“N DE DOCKER
# ------------------------------------------------------------------------------

build: ## ğŸ³ Construye o reconstruye las imÃ¡genes de Docker.
	@echo "ğŸ—ï¸  Construyendo imÃ¡genes de Docker..."
	@docker-compose build

up: ## ğŸš€ Inicia todos los servicios de Docker en segundo plano.
	@echo "ğŸš€ Iniciando contenedores Docker..."
	@docker-compose up -d

start: up ## âœ¨ Alias para 'up'.

down: ## ğŸ›‘ Detiene todos los servicios de Docker.
	@echo "ğŸ›‘ Deteniendo contenedores Docker..."
	@docker-compose down

stop: down ## âœ¨ Alias para 'down'.

destroy: ## ğŸ’£ Detiene y elimina contenedores, redes y volÃºmenes. Â¡CUIDADO!
	@echo "ğŸ’£  Destruyendo todo (contenedores, redes, volÃºmenes)..."
	@docker-compose down -v

logs: ## ğŸ“œ Muestra y sigue los logs de todos los servicios.
	@echo "ğŸ“œ Mostrando logs..."
	@$(COMPOSE_LOGS)

ps: ## ğŸ“Š Lista los contenedores en ejecuciÃ³n.
	@echo "ğŸ“Š Estado de los contenedores:"
	@docker-compose ps

# ------------------------------------------------------------------------------
# CONSOLAS Y SHELL
# ------------------------------------------------------------------------------

shell: ## ğŸš Inicia una sesiÃ³n de shell (bash) dentro del contenedor web.
	@echo "ğŸš Accediendo al shell del contenedor..."
	@$(COMPOSE_EXEC) /bin/bash

console: ## ğŸ’ Inicia la consola de Rails.
	@echo "ğŸ’ Iniciando consola de Rails..."
	@$(COMPOSE_RUN) bundle exec rails console

c: console ## âœ¨ Alias para 'console'.

# ------------------------------------------------------------------------------
# BASE DE DATOS Y RAILS
# ------------------------------------------------------------------------------

db-setup: ## ğŸ› ï¸  Configura la base de datos (crea, migra, carga seeds). Ideal para la primera vez.
	@echo "ğŸ› ï¸  Configurando la base de datos (create, migrate, seed)..."
	@$(COMPOSE_RUN) bundle exec rails db:prepare

db-create: ## ğŸŒ± Crea la base de datos.
	@echo "ğŸŒ± Creando la base de datos..."
	@$(COMPOSE_RUN) bundle exec rails db:create

db-migrate: ## ğŸƒ Ejecuta las migraciones pendientes.
	@echo "ğŸƒ Ejecutando migraciones..."
	@$(COMPOSE_RUN) bundle exec rails db:migrate

db-seed: ## ğŸŒ° Carga los datos iniciales (seeds).
	@echo "ğŸŒ° Cargando seeds..."
	@$(COMPOSE_RUN) bundle exec rails db:seed

db-reset: ## â™»ï¸  Reinicia la base de datos (drop, setup).
	@echo "â™»ï¸  Reiniciando la base de datos..."
	@$(COMPOSE_RUN) bundle exec rails db:reset

routes: ## ğŸ—ºï¸  Muestra todas las rutas de la API.
	@echo "ğŸ—ºï¸  Listando rutas..."
	@$(COMPOSE_RUN) bundle exec rails routes

# ------------------------------------------------------------------------------
# TESTING (CONFIGURADO PARA RSPEC)
# ------------------------------------------------------------------------------

test: ## ğŸ§ª Ejecuta toda la suite de pruebas con RSpec.
	@echo "ğŸ§ª Ejecutando pruebas con RSpec..."
	@RAILS_ENV=test $(COMPOSE_RUN) bundle exec rspec

# Para ejecutar un archivo de test especÃ­fico: make test-file path=spec/models/mi_modelo_spec.rb
test-file: ## ğŸ”¬ Ejecuta un archivo de test especÃ­fico de RSpec. Uso: make test-file path=ruta/al/test.
	@echo "ğŸ”¬ Ejecutando test de RSpec en $(path)..."
	@RAILS_ENV=test $(COMPOSE_RUN) bundle exec rspec $(path)