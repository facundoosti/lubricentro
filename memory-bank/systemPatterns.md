# System Patterns - Arquitectura Lubricentro

## üé® REGLA CR√çTICA: Tailwind CSS First

**‚ö†Ô∏è OBLIGATORIO: Todo el CSS debe usar Tailwind CSS y sus convenciones**

### Principios Fundamentales

1. **üö´ NUNCA escribir CSS personalizado** sin justificaci√≥n t√©cnica
2. **‚úÖ SIEMPRE usar clases de Tailwind** para estilos
3. **üéØ Usar el sistema `@theme`** para definir colores y variables
4. **üì¶ Evitar archivos CSS adicionales** - todo en `index.css` con `@theme`

### Sistema de Colores (Tailwind v4)

```css
/* frontend/src/index.css - √öNICO lugar para definir colores */
@theme {
  --color-gray-50: #f9fafb;    /* bg-gray-50 */
  --color-gray-100: #f2f4f7;   /* bg-gray-100 */
  --color-brand-500: #465fff;  /* bg-brand-500 */
  --color-success-500: #12b76a; /* bg-success-500 */
  --color-error-500: #f04438;   /* bg-error-500 */
  --color-warning-500: #f79009; /* bg-warning-500 */
}
```

### Patrones de Uso

**‚úÖ CORRECTO:**
```jsx
<div className="bg-gray-50 text-gray-800 p-4 rounded-lg shadow-theme-sm">
  <h2 className="text-title-md font-semibold mb-2">T√≠tulo</h2>
  <p className="text-theme-sm text-gray-600">Contenido</p>
</div>
```

**‚ùå INCORRECTO:**
```jsx
<div style={{ backgroundColor: '#f9fafb', padding: '1rem' }}>
  <h2 style={{ fontSize: '36px', fontWeight: 'bold' }}>T√≠tulo</h2>
</div>
```

### Estructura de Archivos CSS

```
frontend/src/
‚îú‚îÄ‚îÄ index.css          # √öNICO archivo CSS con @theme
‚îú‚îÄ‚îÄ components/        # Solo JSX con className
‚îú‚îÄ‚îÄ pages/            # Solo JSX con className
‚îî‚îÄ‚îÄ layout/           # Solo JSX con className
```

### Clases Tailwind Disponibles

**Colores de Fondo:**
- `bg-gray-50`, `bg-gray-100`, `bg-gray-200`... hasta `bg-gray-950`
- `bg-brand-25`, `bg-brand-50`, `bg-brand-500`... hasta `bg-brand-950`
- `bg-success-500`, `bg-error-500`, `bg-warning-500`
- `bg-blue-light-50`, `bg-blue-light-500`... hasta `bg-blue-light-950`
- `bg-orange-50`, `bg-orange-500`... hasta `bg-orange-950`
- `bg-theme-pink-500`, `bg-theme-purple-500`

**Colores de Texto:**
- `text-gray-800`, `text-gray-600`, `text-gray-400`
- `text-brand-500`, `text-success-500`, `text-error-500`
- `text-blue-light-500`, `text-orange-500`
- `text-theme-pink-500`, `text-theme-purple-500`

**Tama√±os de Texto:**
- `text-title-2xl`, `text-title-xl`, `text-title-lg`, `text-title-md`
- `text-theme-xl`, `text-theme-sm`, `text-theme-xs`
- **Line-height autom√°tico** incluido en cada tama√±o

**Sombras:**
- `shadow-theme-sm`, `shadow-theme-md`, `shadow-theme-lg`, `shadow-theme-xl`
- `shadow-theme-xs`, `shadow-datepicker`, `shadow-focus-ring`
- `shadow-slider-navigation`, `shadow-tooltip`
- `drop-shadow-4xl`

**Z-index:**
- `z-1`, `z-9`, `z-99`, `z-999`, `z-9999`, `z-99999`, `z-999999`

**Breakpoints Personalizados:**
- `2xsm:375px`, `xsm:425px`, `3xl:2000px`
- `sm:640px`, `md:768px`, `lg:1024px`, `xl:1280px`, `2xl:1536px`

**Utilities Personalizadas:**
- `menu-item`, `menu-item-active`, `menu-item-inactive`
- `menu-item-icon`, `menu-item-icon-active`, `menu-item-icon-inactive`
- `menu-item-arrow`, `menu-item-arrow-active`, `menu-item-arrow-inactive`
- `menu-dropdown-item`, `menu-dropdown-item-active`, `menu-dropdown-item-inactive`
- `menu-dropdown-badge`, `menu-dropdown-badge-active`, `menu-dropdown-badge-inactive`
- `no-scrollbar`, `custom-scrollbar`

**Dark Mode:**
- `dark:bg-gray-900`, `dark:text-gray-300`
- `dark:bg-brand-500/[0.12]`, `dark:text-brand-400`
- Soporte completo para modo oscuro

### Excepciones Permitidas

**Solo se permite CSS personalizado para:**
1. **Animaciones complejas** que Tailwind no cubre
2. **Integraci√≥n con librer√≠as de terceros** (charts, datepickers)
3. **Hacks espec√≠ficos** para compatibilidad de navegadores

**Ejemplo de excepci√≥n v√°lida:**
```css
/* Solo para integraci√≥n con librer√≠a externa */
.apexcharts-tooltip {
  @apply !bg-gray-900 !border-gray-800;
}
```

## ‚ö†Ô∏è Regla Cr√≠tica de Flujo de Trabajo

**Para evitar errores, todos los comandos deben ejecutarse desde el directorio correcto.**

-   **Comandos de Backend (Rails)**: Deben ejecutarse desde el directorio `backend/`.
    -   `cd backend`
    -   `rails s`, `rails db:migrate`, `rspec`, etc.

-   **Comandos de Frontend (React/NPM)**: Deben ejecutarse desde el directorio `frontend/`.
    -   `cd frontend`
    -   `npm install`, `npm run dev`, `npm test`, etc.

**Esta es una restricci√≥n fundamental de la arquitectura de monorepo que hemos adoptado.**

## Arquitectura General

**Patr√≥n**: API-First con Frontend SPA separado

```
Frontend (React + Tailwind + TailAdmin Template)
        ‚Üï HTTP/JSON API
Backend (Rails API + JWT) ‚úÖ COMPLETADO
        ‚Üï ActiveRecord ORM
Base de Datos (PostgreSQL) ‚úÖ CONFIGURADO
```

## üé® Frontend Architecture Patterns

### Template Base: TailAdmin React

**Estructura de Referencia**:
```
frontend/template-analysis/     # Template original
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îú‚îÄ‚îÄ components/            # Componentes UI base
‚îÇ   ‚îú‚îÄ‚îÄ layout/               # Layouts y navegaci√≥n
‚îÇ   ‚îú‚îÄ‚îÄ pages/                # P√°ginas del dashboard
‚îÇ   ‚îú‚îÄ‚îÄ icons/                # Iconos SVG
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ README.md                 # Documentaci√≥n completa
```

**Nuestra Adaptaci√≥n**:
```
frontend/src/                  # Nuestra implementaci√≥n
‚îú‚îÄ‚îÄ layout/                   # Layout adaptado del template
‚îÇ   ‚îú‚îÄ‚îÄ Layout.jsx           # Estructura principal
‚îÇ   ‚îú‚îÄ‚îÄ Header.jsx           # Header con controles
‚îÇ   ‚îî‚îÄ‚îÄ Sidebar.jsx          # Navegaci√≥n espec√≠fica
‚îú‚îÄ‚îÄ components/              # Componentes UI adaptados
‚îÇ   ‚îú‚îÄ‚îÄ common/              # Componentes reutilizables
‚îÇ   ‚îú‚îÄ‚îÄ ui/                  # Elementos de interfaz
‚îÇ   ‚îî‚îÄ‚îÄ features/            # Componentes espec√≠ficos
‚îú‚îÄ‚îÄ pages/                   # P√°ginas del lubricentro
‚îú‚îÄ‚îÄ contexts/                # Contextos React
‚îú‚îÄ‚îÄ services/                # Servicios API
‚îî‚îÄ‚îÄ utils/                   # Utilidades
```

### Patrones de Componentes

**Container + View Pattern**:
```javascript
// Container: L√≥gica y estado
const ServicesContainer = () => {
  const { data: services, isLoading } = useServices();
  return <ServicesView services={services} loading={isLoading} />;
};

// View: Presentaci√≥n
const ServicesView = ({ services, loading }) => {
  return (
    <div className="dark:bg-boxdark-2 dark:text-bodydark">
      {/* UI Components */}
    </div>
  );
};
```

**Layout Pattern**:
```javascript
// Layout principal con tema oscuro/claro
const Layout = () => {
  const [sidebarOpen, setSidebarOpen] = useState(false);
  
  return (
    <div className="dark:bg-boxdark-2 dark:text-bodydark">
      <div className="flex h-screen overflow-hidden">
        <Sidebar sidebarOpen={sidebarOpen} setSidebarOpen={setSidebarOpen} />
        <div className="relative flex flex-1 flex-col overflow-y-auto overflow-x-hidden">
          <Header sidebarOpen={sidebarOpen} setSidebarOpen={setSidebarOpen} />
          <main>
            <div className="mx-auto max-w-screen-2xl p-4 md:p-6 2xl:p-10">
              <Outlet />
            </div>
          </main>
        </div>
      </div>
    </div>
  );
};
```

### Routing Patterns

**React Router Setup**:
```javascript
// App.jsx - Rutas espec√≠ficas del lubricentro
<Routes>
  <Route path="/" element={<Layout />}>
    <Route index element={<Dashboard />} />
    <Route path="services" element={<Services />} />
    <Route path="customers" element={<Customers />} />
    <Route path="vehicles" element={<Vehicles />} />
    <Route path="appointments" element={<Appointments />} />
    <Route path="products" element={<Products />} />
    <Route path="settings" element={<Settings />} />
  </Route>
</Routes>
```

### State Management Patterns

**React Query para Server State**:
```javascript
// services/api.js
const api = axios.create({
  baseURL: '/api/v1',
  headers: { Authorization: `Bearer ${token}` }
});

// hooks/useServices.js
const useServices = () => {
  return useQuery('services', () => api.get('/services'));
};

const useCreateService = () => {
  return useMutation((serviceData) => api.post('/services', serviceData));
};
```

**Context solo para Auth**:
```javascript
// contexts/QueryProvider.jsx
const QueryProvider = ({ children }) => {
  const queryClient = new QueryClient({
    defaultOptions: {
      queries: { staleTime: 5 * 60 * 1000 }, // 5 minutos
    },
  });
  
  return (
    <QueryClientProvider client={queryClient}>
      {children}
      <ReactQueryDevtools />
    </QueryClientProvider>
  );
};
```

### UI/UX Patterns

**Tailwind Design System**:
```javascript
// Colores consistentes (del template)
primary: 'blue-600'     // Acciones principales
secondary: 'gray-600'   // Elementos secundarios
success: 'green-600'    // Estados exitosos
danger: 'red-600'       // Errores y eliminaciones
warning: 'yellow-600'   // Alertas

// Tema oscuro/claro
dark:bg-boxdark-2 dark:text-bodydark  // Clases del template
```

**Componentes Reutilizables**:
```javascript
// Button con variantes
<Button variant="primary" size="md" loading={isLoading}>
  Guardar
</Button>

// Modal para confirmaciones
<Modal isOpen={isOpen} onClose={onClose}>
  <ModalContent>...</ModalContent>
</Modal>

// Table con paginaci√≥n
<Table data={data} columns={columns} pagination={pagination} />
```

### Form Patterns

**React Hook Form + Yup**:
```javascript
const schema = yup.object({
  name: yup.string().required('El nombre es requerido'),
  price: yup.number().positive('El precio debe ser positivo'),
});

const { register, handleSubmit, formState: { errors } } = useForm({
  resolver: yupResolver(schema)
});
```

## Modelo de Datos ‚úÖ IMPLEMENTADO

### ‚ö†Ô∏è IMPORTANTE: Decisi√≥n T√©cnica Cr√≠tica

**TODOS los campos de base de datos, modelos, y c√≥digo deben estar en INGL√âS**

- Mejores pr√°cticas de desarrollo
- Escalabilidad internacional
- Consistencia con el stack tecnol√≥gico
- Facilita mantenimiento y colaboraci√≥n

### Entidades Core ‚úÖ TODAS IMPLEMENTADAS

```
Customer ‚úÖ
‚îú‚îÄ‚îÄ id, name, phone, email, address
‚îú‚îÄ‚îÄ created_at, updated_at
‚îî‚îÄ‚îÄ has_many :vehicles, :appointments, :service_records

Vehicle ‚úÖ
‚îú‚îÄ‚îÄ id, brand, model, license_plate, year, customer_id
‚îú‚îÄ‚îÄ created_at, updated_at
‚îî‚îÄ‚îÄ belongs_to :customer, has_many :appointments, :service_records

Appointment ‚úÖ
‚îú‚îÄ‚îÄ id, scheduled_at, status, notes
‚îú‚îÄ‚îÄ customer_id, vehicle_id
‚îú‚îÄ‚îÄ created_at, updated_at
‚îî‚îÄ‚îÄ belongs_to :customer, :vehicle

Service ‚úÖ
‚îú‚îÄ‚îÄ id, name, description, base_price
‚îú‚îÄ‚îÄ created_at, updated_at
‚îî‚îÄ‚îÄ has_many :service_record_services

Product ‚úÖ
‚îú‚îÄ‚îÄ id, name, description, unit_price, unit
‚îú‚îÄ‚îÄ created_at, updated_at
‚îî‚îÄ‚îÄ has_many :service_record_products

ServiceRecord ‚úÖ COMPLETADO
‚îú‚îÄ‚îÄ id, service_date, total_amount, notes, mileage, next_service_date
‚îú‚îÄ‚îÄ customer_id, vehicle_id
‚îú‚îÄ‚îÄ created_at, updated_at
‚îî‚îÄ‚îÄ belongs_to :customer, :vehicle
    has_many :service_record_services, :service_record_products

ServiceRecordService (FUTURO)
‚îú‚îÄ‚îÄ id, service_record_id, service_id, price
‚îî‚îÄ‚îÄ belongs_to :service_record, :service

ServiceRecordProduct (FUTURO)
‚îú‚îÄ‚îÄ id, service_record_id, product_id, quantity, unit_price
‚îî‚îÄ‚îÄ belongs_to :service_record, :product
```

## Patrones de Backend (Rails) ‚úÖ IMPLEMENTADOS

### Database Configuration ‚úÖ

```ruby
# config/database.yml
default: &default
  adapter: postgresql
  encoding: unicode
  pool: <%= ENV.fetch("RAILS_MAX_THREADS") { 5 } %>

development:
  <<: *default
  database: lubricentro_development

test:
  <<: *default
  database: lubricentro_test

production:
  <<: *default
  url: <%= ENV['DATABASE_URL'] %>
```

### Estructura de Controllers ‚úÖ COMPLETADA

```
app/controllers/
‚îú‚îÄ‚îÄ application_controller.rb (autenticaci√≥n JWT preparada)
‚îú‚îÄ‚îÄ api/
    ‚îî‚îÄ‚îÄ v1/
        ‚îú‚îÄ‚îÄ customers_controller.rb ‚úÖ
        ‚îú‚îÄ‚îÄ vehicles_controller.rb ‚úÖ
        ‚îú‚îÄ‚îÄ appointments_controller.rb ‚úÖ
        ‚îú‚îÄ‚îÄ services_controller.rb ‚úÖ
        ‚îú‚îÄ‚îÄ products_controller.rb ‚úÖ
        ‚îî‚îÄ‚îÄ service_records_controller.rb ‚úÖ
```

### Patr√≥n de Respuestas API ‚úÖ IMPLEMENTADO

```ruby
# Success Response
{
  success: true,
  data: { ... },
  message: "Success message"
}

# Error Response
{
  success: false,
  errors: ["Error message"],
  message: "Error occurred"
}
```

### Validaciones y Reglas de Negocio ‚úÖ IMPLEMENTADAS

```ruby
# En cada modelo - CAMPOS EN INGL√âS
validates :name, presence: true, uniqueness: true
validates :license_plate, presence: true, uniqueness: true
validate :custom_business_rule

# Service Objects para l√≥gica compleja (FUTURO)
class ServiceRecordCalculator
  def calculate_total(services, products)
    # L√≥gica de c√°lculo
  end
end
```

### Serializaci√≥n con Blueprint ‚úÖ IMPLEMENTADA

```ruby
# Patr√≥n establecido para todos los modelos
class ServiceRecordSerializer < Blueprinter::Base
  identifier :id
  
  view :default do
    field :service_date, :total_amount, :notes, :mileage
    field :customer_id, :vehicle_id
  end
  
  view :summary do
    field :total_amount, :mileage, :service_date
    exclude :notes, :created_at, :updated_at
  end
  
  view :with_details do
    field :formatted_total_amount, :formatted_service_date
    field :is_overdue, :days_until_next_service
  end
end
```

### Testing Patterns ‚úÖ IMPLEMENTADOS

```ruby
# Model specs con shoulda-matchers
describe ServiceRecord do
  it { should belong_to(:customer).required }
  it { should belong_to(:vehicle).required }
  it { should validate_presence_of(:service_date) }
  it { should validate_numericality_of(:total_amount).is_greater_than_or_equal_to(0) }
end

# Factory patterns con traits
FactoryBot.define do
  factory :service_record do
    trait :overdue do
      next_service_date { 1.month.ago }
    end
    
    trait :upcoming do
      next_service_date { 1.month.from_now }
    end
  end
end
```

## Patrones de Frontend (React) üöß PENDIENTE

### Estructura de Componentes

```
src/
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ layout/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Layout.jsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Navigation.jsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Header.jsx
‚îÇ   ‚îú‚îÄ‚îÄ common/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Button.jsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Modal.jsx
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Table.jsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Form/
‚îÇ   ‚îî‚îÄ‚îÄ features/
‚îÇ       ‚îú‚îÄ‚îÄ customers/
‚îÇ       ‚îú‚îÄ‚îÄ vehicles/
‚îÇ       ‚îú‚îÄ‚îÄ appointments/
‚îÇ       ‚îú‚îÄ‚îÄ services/
‚îÇ       ‚îú‚îÄ‚îÄ products/
‚îÇ       ‚îú‚îÄ‚îÄ service-records/
‚îÇ       ‚îî‚îÄ‚îÄ reports/
‚îú‚îÄ‚îÄ hooks/
‚îú‚îÄ‚îÄ services/ (API calls)
‚îú‚îÄ‚îÄ contexts/
‚îî‚îÄ‚îÄ utils/
```

### Patr√≥n de Gesti√≥n de Estado

```javascript
// Context API para estado global
const AppContext = createContext();

// Custom hooks para l√≥gica reutilizable
const useCustomers = () => { ... }
const useServiceRecord = () => { ... }

// React Query para cache de API
const { data, loading, error } = useQuery('customers', fetchCustomers);
```

### Patr√≥n de Componentes

```jsx
// Componente Container (l√≥gica)
const CustomersContainer = () => {
  // L√≥gica del componente
  return <CustomersView {...props} />;
};

// Componente Presentacional (UI)
const CustomersView = ({ customers, onAdd, onEdit }) => {
  // Solo renderizado
};
```